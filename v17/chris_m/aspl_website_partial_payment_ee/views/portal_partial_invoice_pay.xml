<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template inherit_id="account_payment.portal_invoice_payment" name="Invoice Payment" id="portal_invoice_payment_inherit">
        <xpath expr="//div[@id='pay_with']/div/div/div" position="after">
             <div class="" t-if="invoice.state == 'posted' and invoice.payment_state in ('not_paid', 'partial') and invoice.amount_total" id="portal_pay">
                <table class="table">
                    <tr>
                        <td style="width: 50%;">
                            <b>Sale Order: </b>
                        </td>
                        <td style="text-align: left;width: 50%;">
                            <span t-esc="invoice.invoice_origin"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 50%;">
                            <b>Invoice:</b>
                        </td>
                        <td style="text-align: left;width: 50%;">
                            <span t-esc="invoice.name"/>
                        </td>
                </tr>
                    <tr>
                        <td style="width: 50%;">
                            <b>Total Amount:</b>
                        </td>
                        <td style="text-align: left;width: 50%;">
                            <span
                                    t-esc="invoice.amount_total"
                                    t-options='{"widget": "monetary", "display_currency": invoice.currency_id}'
                            />
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 50%;">
                            <b>Remaining Amount:</b>
                        </td>
                        <td style="text-align: left;width: 50%;">
                            <span
                                    t-esc="invoice.amount_residual"
                                    t-options='{"widget": "monetary", "display_currency": invoice.currency_id}'
                            />
                        </td>
                    </tr>
                    <tr t-if="user_id.partner_id.allow_partial_payment">
                        <td style="width: 50%;" class="invoice_partial_payment_switch_button">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="payment_invoice_checkbox"/>
                                <label class="custom-control-label" for="payment_invoice_checkbox">Down-Payment</label>
                            </div>
                        </td>
                        <td>
                            <input type="text" id="payment_invoice_values" t-att-value="'{0:.2f}'.format(invoice.amount_residual)"
                                   t-att-data-max="invoice.amount_residual" name="payment_values"
                                   style="width:35%;"
                            />
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <input type="hidden" t-att-value="invoice.amount_residual" id="invoice_residual"/>
                            <input type="hidden" t-att-value="invoice.amount_total" id="amount_total"/>
                            <input type="hidden" t-att-value="invoice.id" id="invoice_id"/>
                        </td>
                    </tr>
                </table>
            </div>
        </xpath>
    </template>

    <template id="account_payment.portal_my_invoices_payment" name="Payment on My Invoices" inherit_id="account.portal_my_invoices">
        <xpath expr="//t[@t-call='portal.portal_table']/thead/tr/th[last()]" position="before">
            <th class="text-center">Status</th>
        </xpath>
        <!-- Remove -->
        <!-- <xpath expr="//t[@t-foreach='invoices']/tr/td[last()]" position="before">
            <td class="text-center">
                <t t-set="tx_ids" t-value="invoice.transaction_ids.filtered(lambda tx: tx.state in ('pending', 'authorized', 'done'))"/>
                <t t-set="pending_manual_txs" t-value="tx_ids.filtered(lambda tx: tx.state == 'pending' and tx.provider_id.code in ('transfer', 'manual'))"/>
                <a t-if="invoice.state == 'posted' and invoice.payment_state in ('not_paid', 'partial') and invoice.amount_total and invoice.move_type == 'out_invoice'"
                    t-att-href="invoice.get_portal_url(anchor='portal_pay')" title="Pay Now" aria-label="Pay now" class="btn btn-sm btn-primary" role="button">
                    <i class="fa fa-arrow-circle-right"/><span class='d-none d-md-inline'> Pay Now</span>
                </a>
            </td>
        </xpath> -->
        <!-- Add -->
        <xpath expr="//t[@t-foreach='invoices']/tr/td[last()]" position="before">
            <td class="text-center">
                <a t-if="invoice._has_to_be_paid()"
                    t-att-href="invoice.get_portal_url(anchor='portal_pay')" title="Pay Now" aria-label="Pay now" class="btn btn-sm btn-primary" role="button">
                    <i class="fa fa-arrow-circle-right"/><span class='d-none d-md-inline'> Pay Now</span>
                </a>
            </td>
        </xpath>

        <!-- Remove -->
        <!-- <xpath expr="//t[@t-foreach='invoices']/tr/td[hasclass('tx_status')]" position="replace">
            <t t-set="last_tx" t-value="invoice.get_portal_last_transaction()"/>
            <td class="tx_status text-center">
                <t t-if="invoice.state == 'posted' and invoice.payment_state in ('not_paid', 'partial') and invoice.amount_residual > 0">
                    <span class="badge rounded-pill text-bg-info"><i class="fa fa-fw fa-clock-o"></i><span class="d-none d-md-inline"> Waiting for Payment</span></span>
                </t>
                <t t-if="invoice.state == 'posted' and last_tx.state == 'authorized'">
                    <span class="badge rounded-pill text-bg-primary"><i class="fa fa-fw fa-check"/><span class="d-none d-md-inline"> Authorized</span></span>
                </t>
                <t t-if="invoice.state == 'posted' and last_tx.state == 'pending' and last_tx.provider_id.code not in ('transfer', 'manual')">
                  <span class="badge rounded-pill text-bg-warning"><span class="d-none d-md-inline"> Pending</span></span>
                </t>
                <t t-if="invoice.state == 'posted' and invoice.payment_state in ('paid', 'in_payment') or last_tx.state == 'done' and invoice.amount_residual == 0">
                    <span class="badge rounded-pill text-bg-success"><i class="fa fa-fw fa-check"></i><span class="d-none d-md-inline"> Paid</span></span>
                </t>
                <t t-if="invoice.state == 'cancel'">
                    <span class="badge rounded-pill text-bg-danger"><i class="fa fa-fw fa-remove"></i><span class="d-none d-md-inline"> Cancelled</span></span>
                </t>
            </td>
        </xpath> -->

        <!-- Add -->
        <!-- <xpath expr="//span[@name='invoice_status_waiting_for_payment']" position="before">
            <span t-elif="invoice.payment_state in ('not_paid', 'partial') and tx_sudo.state == 'authorized'"
                    class="badge rounded-pill text-bg-primary">
                <i class="fa fa-fw fa-check"/>
                <span class="d-none d-md-inline"> Authorized</span>
            </span>
            <span t-elif="invoice.payment_state in ('not_paid', 'partial') and tx_sudo.state == 'pending' and tx_sudo.provider_code not in ('none', 'custom')"
                    class="badge rounded-pill text-bg-warning">
                <span class="d-none d-md-inline"> Pending</span>
            </span>
            <span t-elif="invoice.payment_state in ('paid', 'in_payment') and tx_sudo.state == 'done'" class="badge rounded-pill text-bg-success">
                <i class="fa fa-fw fa-check"></i>
                <span class="d-none d-md-inline"> Paid</span>
            </span>
        </xpath> -->

    </template>

    <template id="account_payment.portal_invoice_page_inherit_payment" name="Payment on My Invoices" inherit_id="account.portal_invoice_page">
        <xpath expr="//t[@t-call='portal.portal_record_sidebar']//div[hasclass('o_download_pdf')]" position="before">
            <t t-set="tx_ids" t-value="invoice.transaction_ids.filtered(lambda tx: tx.state in ('pending', 'authorized', 'done'))"/>
            <t t-set="pending_manual_txs" t-value="tx_ids.filtered(lambda tx: tx.state == 'pending' and tx.provider_id.code in ('transfer', 'manual'))"/>
            <div class="d-grid">
                <a href="#" t-if="invoice.state == 'posted' and invoice.payment_state in ('not_paid', 'partial') and invoice.amount_total and invoice.move_type == 'out_invoice'"

                    class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#pay_with">
                    <i class="fa fa-fw fa-arrow-circle-right"/> Pay Now
                </a>
                <div t-if="tx_ids and not pending_manual_txs and invoice.payment_state != 'paid'" class="alert alert-info py-1 mb-2" >
                    <i class="fa fa-fw fa-check-circle"/> Pending
                </div>
                <div t-if="invoice.payment_state == 'paid'" class="alert alert-success py-1 mb-2" >
                    <i class="fa fa-fw fa-check-circle"/> Paid
                </div>
            </div>
        </xpath>
        <xpath expr="//div[@id='invoice_content']//div[hasclass('o_portal_html_view')]" position="before">

            <t t-set="tx_ids" t-value="invoice.transaction_ids.filtered(lambda tx: tx.state in ('authorized', 'done'))"/>
            <div t-if="invoice.state == 'posted' and invoice.payment_state in ('not_paid', 'partial') and invoice.amount_total" id="portal_pay">
                <t t-call="account_payment.portal_invoice_payment"/>
            </div>
            <div class="panel-body" t-if="existing_token">
                <div class="offset-lg-3 col-lg-6">
                    <i class="fa fa-info"></i> You have credits card registered, you can log-in to be able to use them.
                </div>
            </div>
        </xpath>
    </template>

</odoo>
